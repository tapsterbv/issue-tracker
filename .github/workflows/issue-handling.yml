name: Issue handling
on:
  issues:
    types:
      - opened
      - labeled
jobs:
  frontend:
    if: github.event.label.name == 'frontend'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Fetch data
        id: fetch-data
        uses: octokit/graphql-action@v2.x 
        with:
          GITHUB_TOKEN: ${{secrets.WORKFLOW_API_KEY_GITHUB}}
          query: |
            query FindMutationInfo($issue_id: Int!, $owner:String!,$issue_repo:String!,$dst_repo:String!) {
              issueRepo: repository(owner:$owner, name:$issue_repo) {
                issue (number: $issue_id) {
                  id
                }
              }
              dstRepo: repository(owner: $owner, name:$dst_repo) {
                id
              }
            }
          issue_id: ${{ github.event.issue.number }}
          owner: "tapsterbv"
          issue_repo: "issue-tracker"
          dst_repo: "bambooims-frontend"
      - name: Debug fetched data
        run: |
          echo "Fetched Data: ${{ toJson(steps.fetch-data.outputs.data) }}"
      - name: Mutate issue
        uses: octokit/graphql-action@v2.x
        env:
          ISSUE_ID: ${{ fromJson(steps.fetch-data.outputs.data).issueRepo.issue.id }}
          REPOSITORY_ID: ${{ fromJson(steps.fetch-data.outputs.data).dstRepo.id }}
        with:
          GITHUB_TOKEN: ${{secrets.WORKFLOW_API_KEY_GITHUB}}
          query: |
            mutation TransferIssue ($issueId: ID!, $repositoryId: ID!) {
              transferIssue(input: {issueId: $issueId, repositoryId: $repositoryId}) {
                issue {
                  url
                  number
                }
              }
            }
          issueId: ${{ env.ISSUE_ID }}
          repositoryId: ${{ env.REPOSITORY_ID }}
